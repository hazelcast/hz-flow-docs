= Enabling authentication
:description: Configuring {short-product-name} to require authentication through Management Center

{short-product-name} does not provide a user interface for managing users or roles. Instead, it relies on the https://docs.hazelcast.com/management-center/5.5[Management Center] (MC) for identity management, utilizing https://docs.hazelcast.com/management-center/5.5/deploy-manage/security-providers[MC security providers] as identity providers. When a user attempts to access Flow, they will be redirected to the identity provider's login page as configured with the MC.

Single Sign-On (SSO) and Single Logout (SLO) are pre-configured between Flow and MC, ensuring a seamless login and logout experiences. This means that when a user logs in or out of one product, they are automatically logged in or out of the other.

== Identity provider configuration through Management Center
Users *must* configure their identity providers through MC. This can be done either on user interface of MC or https://docs.hazelcast.com/management-center/5.5/deploy-manage/mc-conf[Management Center Configuration Tool].

There are 2 ways to use MC as an identity provider:

. MC can act as the identity provider itself for the following security providers:
  * https://docs.hazelcast.com/management-center/5.5/deploy-manage/local-security-provider[Local Security Provider]
  * https://docs.hazelcast.com/management-center/5.5/deploy-manage/active-directory[Active Directory]
  * https://docs.hazelcast.com/management-center/5.5/deploy-manage/jaas[JAAS]
  * https://docs.hazelcast.com/management-center/5.5/deploy-manage/ldap[LDAP]
. MC can be configured to use an external identity provider for the following security providers:
  * https://docs.hazelcast.com/management-center/5.5/deploy-manage/saml[SAML]
  * https://docs.hazelcast.com/management-center/5.5/deploy-manage/openid[Open ID connect]

== Steps to run Flow with Management Center as the identity provider:

. Run docker compose file to spin up Flow and MC. Security provider can be configured in 2 ways:
  a. Through https://docs.hazelcast.com/management-center/5.5/deploy-manage/mc-conf[Management Center Configuration Tool]. An example can be found below.
  b. Through user interface of MC. To do this, open the landing page of Flow or MC. An example can be found below.
. After security provider is configured through MC, go to the landing page of Flow or MC.
  * Flow is configured to run on http://localhost:9021 unless overridden.
  * MC is configured to run on http://localhost:8080 unless overridden.
. Enter your credentials and login. Thanks to SSO, you are logged into both applications.

////
Internal notes to Hazelcast employees:

Flow is distributed to customers with MC pre-configured as the single source of authentication. For Flow-MC Single-Sign-On integration, Open ID connect authentication service, via authorization code flow with PKCE pattern is used. Flowâ€™s security configuration will not be disclosed to customers to prevent potential misuse.

Here is an example docker compose file for security pre-configuration of Flow with MC:

environment:
    VYNE_SECURITY_OPENIDP_SCOPE: "openid email profile"
    OPTIONS: >-
#       To enable OpenID Connect authentication. Defaults to false.
        --vyne.security.openIdp.enabled=true

#       The openIdp issuer endpoint. The browser will redirect to this endpoint, so ensure the DNS entry is accessible via browser traffic. localhost is possibly OK here.
        --vyne.security.openIdp.issuerUrl=http://localhost:8080

#       The client ID to present to OpenID server.
        --vyne.security.openIdp.clientId=flow-client

#       A URL to load the set of JWKs used to verify signatures of presented tokens. This URL is called by Flow's server, so ensure that the DNS entry is accessible to Flow. localhost is unlikely to work here.
        --vyne.security.openIdp.jwks-uri=http://host.docker.internal:8080/oauth2/jwks

#       Indicates if auth must be performed over https. Defaults to true.
        --vyne.security.openIdp.require-https=false

#       To configure Flow to read the roles from the JWT, set to path to provide a custom path.
        --vyne.security.open-idp.roles.format=path

#       To configure Flow to read the roles from the JWT, set to the path within the JWT for the roles.
        --vyne.security.open-idp.roles.path=roles

#       To disable refresh tokens. When disabled, Flow performs silent refresh for OIDC implicit flow via hidden iframe. Defaults to false.
        --vyne.security.open-idp.refreshTokensDisabled=true

#       Optional. A URL where authenticated users may be redirected, to manage their account
#       --vyne.security.openIdp.account-management-url=http:..localhost:8080/settings

#       Optional. A URL where authenticated users may be redirected, to manage their organization. Generally, this is where roles are assigned to users
#       --vyne.security.openIdp.org-management-url=http:..localhost:8080/settings

------------------------------------

The presented JWT is expected to have the following attributes:
 * sub: Required, subject - identifier for the end-user at the issuer.
 * iss: Required, issuer - the OIDC provider who authenticated the user.
 * One of preferred_username or first_name and last_name: Required, shorthand name by which the end-iser wishes to be referred to at the RP, such as janedoe or j.doe.
 * One of email or clientId: Required, something that uniquely identifies the user.
 * One of picture or picture_url: Optional, the user's avatar.
 * name: Optional, end-user's full name in displayable form including all name parts, possibly including titles and suffixes, ordered according to the end-user's locale and preferences.

////

Below you can find example docker compose files where MC is the identity provider and a more complex scenario where MC is configured to use an external identity provider.

=== Example docker compose file with local security configuration via hz-mc tool
Run the following docker compose file with username `admin` and password `Hazelcast135!`:

// The following docker compose file needs to be merged with security pre-configuration of Flow with MC above.
[,yaml]
----
services:
   management-center:
#     TODO: update with public MC image with Flow build.
      image: quay.io/hazelcast_cloud/management-center-flow:latest
      ports:
         - "8080:8080"
      environment:
         - JAVA_OPTS=-Dhazelcast.mc.flow.address=http://localhost:9021 -Dhazelcast.mc.flow.internalAddress=http://flow:9021
         - MC_LICENSE=${MC_LICENSE}
         - MC_INIT_CMD=./bin/mc-conf.sh security reset && ./bin/mc-conf.sh user create -n admin -r admin -p "Hazelcast135!"

   flow:
#     TODO: update with public Flow image.
      image: quay.io/hazelcast_cloud/hazelcast-flow-internal:next
      pull_policy: "always"
      environment:
         JAVA_OPTS: >-
            -Xms256m
            -Xmx1024m
         OPTIONS: >-
            --vyne.analytics.persistRemoteCallResponses=true
            --vyne.analytics.persistResults=true
#           TODO: remove orbital worded configuration.
            --vyne.db.username=orbital
            --vyne.db.password=changeme
            --vyne.db.host=postgres
            --vyne.workspace.project-file=/opt/service/workspace/taxi.conf
      ports:
         - "9021:9021"
      expose:
         - 9021
      depends_on:
         - postgres

   postgres:
      image: postgres:15
      expose:
         - 5432
      ports:
         - "25432:5432"
      environment:
         POSTGRES_USER: postgres
         POSTGRES_PASSWORD: changeme
----
Notice usage of `./bin/mc-conf.sh`.

Once the containers have started, go to the landing page of MC or Flow, and you will see the following login screen:

image:mc-local-security-provider-login.png[]

=== Example docker compose file with external identity provider configuration through user interface
Run the following docker compose file:

// The following docker compose file needs to be merged with security pre-configuration of Flow with MC above.
[,yaml]
----
services:
   management-center:
#     TODO: update with public MC image with Flow build.
      image: quay.io/hazelcast_cloud/management-center-flow:latest
      ports:
         - "8080:8080"
      environment:
         - JAVA_OPTS=-Dhazelcast.mc.flow.address=http://localhost:9021 -Dhazelcast.mc.flow.internalAddress=http://flow:9021
         - MC_LICENSE=${MC_LICENSE}
         - MC_INIT_CMD=./bin/mc-conf.sh security reset

   flow:
#     TODO: update with public Flow image.
      image: quay.io/hazelcast_cloud/hazelcast-flow-internal:next
      pull_policy: "always"
      environment:
         JAVA_OPTS: >-
            -Xms256m
            -Xmx1024m
         OPTIONS: >-
            --vyne.analytics.persistRemoteCallResponses=true
            --vyne.analytics.persistResults=true
#           TODO: remove orbital worded configuration.
            --vyne.db.username=orbital
            --vyne.db.password=changeme
            --vyne.db.host=postgres
            --vyne.workspace.project-file=/opt/service/workspace/taxi.conf
      ports:
         - "9021:9021"
      expose:
         - 9021
      depends_on:
         - postgres

   postgres:
      image: postgres:15
      expose:
         - 5432
      ports:
         - "25432:5432"
      environment:
         POSTGRES_USER: postgres
         POSTGRES_PASSWORD: changeme
----

Once the containers have started, configure your external identity provider with https://docs.hazelcast.com/management-center/5.5/deploy-manage/openid[OIDC] or https://docs.hazelcast.com/management-center/5.5/deploy-manage/saml[SAML], go to the landing page of MC or Flow, and you will see the following login screen:

image:external-idp-oidc-login.png[]

== See also

* xref:authorization.adoc[Role-based authorization]
